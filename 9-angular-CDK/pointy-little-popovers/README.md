# How it works...

Implementing an overlay using the Angular CDK Overlay API includes a couple of pieces to work with. We first have to import the `OverlayModule` class in our `AppModule` imports. Then, for creating an overlay, we need to have an overlay and an overlay trigger. In this recipe, since we're using the overlay to create a popover menu for each list item, we use the `cdkOverlayOrigin` directive on the `<app-the-amazing-list- item>` elements.
Notice that the `<app-the-amazing-list-item>` elements are being rendered through the `*ngFor` directive. Therefore, in order to know which
item was clicked or precisely which item we need to show the popover for, we create a `#itemTrigger` template variable on each list-item element, and you'll notice that we also bind the (click) event on the list items to call the `openMenu()` method, passing this `itemTrigger` template variable into it.
Now, if you have noticed the `openMenu()` method in the `the-amazing-list. component.ts` file, it looks like this:
`openMenu($event, itemTrigger) {
  if ($event) {
    $event.stopImmediatePropagation();
  }
  this.popoverMenuTrigger = itemTrigger;
  this.menuShown = true;
}`
Notice that we assign the `itemTrigger` property to our class's `popoverMenuTrigger` property. This is because this `popoverMenuTrigger` property is being bound with the actual overlay in our template. You can also see that we set the `menuShown` property to true, and this is because it will decide whether the overlay should be shown or hidden.
Now, let's see the code for the actual overlay, as follows:
`<ng-template cdkConnectedOverlay
[cdkConnectedOverlayOrigin]="popoverMenuTrigger"
[cdkConnectedOverlayOpen]="menuShown"
[cdkConnectedOverlayHasBackdrop]="true"
(backdropClick)="menuShown = false"
[cdkConnectedOverlayPositions]="menuPositions"
appPopoverPositionalClass targetSelector=".menu-popover"
inverseClass="menu-popover--up"
[originY]="menuPopoverOrigin.originY"
(positionChange)="popoverPositionChanged($event, menuPopoverOrigin)"
cdkConnectedOverlayPanelClass="menu-popover"

> ...
> </ng-template>`

Let's discuss each of the `cdkConnectedOverlay` directive's attributes, one by one:
• The `cdkConnectedOverlay` attribute: This is the actual overlay directive that makes the `<ng-template>` element an Angular CDK overlay.
• The `[cdkConnectedOverlayOrigin]` attribute: This tells the Overlay API what the origin of this overlay is This is to help the CDK decide where to position the overlay when opened.
• The `[cdkConnectedOverlayOpen]` attribute: This decides whether the overlay should be shown or not.
• The `[cdkConnectedOverlayHasBackdrop]` attribute: This decides whether the overlay should have a backdrop or not—that is, if it has a backdrop, the user shouldn't be able to click anything else apart from the overlay when it is open.
• The `(backdropClick)` attribute: This is the event handler for when we click the backdrop. In this case, we're setting the `menuShown` property to false, which hides/closes the overlay.
• The `[cdkConnectedOverlayPositions]` attribute: This provides the positioning configuration to the Overlay API. It is an array of preferred positions that defines whether the overlay should be shown below the origin, on top of the origin, on the left, on the right, how far from the origin, and so on.
• The `[cdkConnectedOverlayPanelClass]` attribute: A Cascading Style Sheets (CSS) class to be applied to the generated overlay. This is used for styling.

So, the Angular CDK Overlay API already has a lot of things covered, including where to position the overlay based on the available space, and since we want to show the pointy arrows, we'll have to analyze whether the overlay is being shown above the item or below the item. By default, we have the following styles set in the `src/styles.scss` file to show the pointy arrow below the popover:
`&::before {
  top: -10px;
  border-width: 0px 10px 10px 10px;
  border-color: transparent transparent white  transparent;
  position: absolute;
  content: '';
  right: 5%;
  border-style: solid;
}`
And then, we have the `--up` modifier class, as follows, to show the overlay above the popover:
`&--up {
  transform: translateY(-20px);
  &::before {
  top: unset !important;
  transform: rotate(180deg);
  bottom: -10px;
}}`

Notice in the preceding code snippet that we rotate the arrow to 180deg to invert its pointer.
Now, let's talk about how and when this `--up` modifier class is applied. We have created a custom directive named `appPopoverPositionalClass`. This directive is also applied to the `<ng-template>` element we have for the overlay—that is, this directive is applied with the `cdkConnectedOverlay` directive and expects the following input attributes:
• The `appPopoverPositionalClass` attribute: The actual directive selector.
• The `targetSelector` attribute: The query selector for the element that is generated by the Angular CDK Overlay API. Ideally, this should be the same as what we use in cdkConnectedOverlayPanelClass.
• The `inverseClass` attribute: The class to be applied when the vertical position (originY) of the overlay is changed—that is, from "top" to "bottom", and vice versa.
• The `originY` attribute: The `originY` position of the overlay at the moment. The value is either "`top`" or "`bottom`", based on the overlay position.
We have a `(positionChange)` listener on the CDK Overlay `<ng-template>` element that triggers the `popoverPositionChanged()` method as soon as the overlay position changes. Notice that inside the `popoverPositionChanged()` method, upon getting a new position, we update the `popover.originY`
property that is updating `menuPopoverOrigin.originY`, and then we're also
passing `menuPopoverOrigin.originY` as the `[originY]` attribute to our `appPopoverPositionalClass` directive. Since we're passing it to the directive, the directive knows if the overlay position is "`top`" or "`bottom`" at any particular time. How? Because we're using the `ngOnChanges` life cycle hook in the directive to listen to the `originY` attribute/input, and as soon as we get a different value for `originY`, we either add the value of `inverseClass` as a CSS class to the Overlay element or remove it based on the value of the originY attribute. Also, based on the applied CSS classes, the direction of the popover arrow is decided for the overlay.

# PointyLittlePopovers

This project was generated with [Angular CLI](https://github.com/angular/angular-cli) version 11.1.3.

## Development server

Run `ng serve` for a dev server. Navigate to `http://localhost:4200/`. The app will automatically reload if you change any of the source files.

## Code scaffolding

Run `ng generate component component-name` to generate a new component. You can also use `ng generate directive|pipe|service|class|guard|interface|enum|module`.

## Build

Run `ng build` to build the project. The build artifacts will be stored in the `dist/` directory. Use the `--prod` flag for a production build.

## Running unit tests

Run `ng test` to execute the unit tests via [Karma](https://karma-runner.github.io).

## Running end-to-end tests

Run `ng e2e` to execute the end-to-end tests via [Protractor](http://www.protractortest.org/).

## Further help

To get more help on the Angular CLI use `ng help` or go check out the [Angular CLI Overview and Command Reference](https://angular.io/cli) page.
